<!DOCTYPE html>
<html lang="en">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="author" content="Hung Hoang">
  <link rel="shortcut icon" href="https://hoangquochung1110.github.io/static-site-generator/favicon.ico">

  <title>Upgrade django queries with F() expression - Hung Hoang</title>

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" href="" />

  <!-- Bootstrap core CSS -->
  <link href="./static/bootstrap.min.css" rel="stylesheet">

  <!-- Custom styles for this template -->
  <link href="./static/style.css" rel="stylesheet">

  <!-- Syntax highlighting css -->
  <link href="./static/pygments.css" rel="stylesheet">

  <!-- Google Tag Manager -->
  <script>
    (function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
    j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
    'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-TG55DGQ');
  </script>
  <!-- End Google Tag Manager -->
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-235710440-2"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-235710440-2');
  </script>
  <!-- End Global site tag (gtag.js) - Google Analytics -->
  <!-- Google Console Verify-->
  <meta name="google-site-verification" content="OgYcJ0DRlzDfeYySnQ7N5_zh_QDavnLwdffF-NQYb6c" />
  <!-- End Google Console Verify-->

  
<meta property="og:title" content="Upgrade django queries with F() expression - Hung Hoang">
<meta property="twitter:title" content="Upgrade django queries with F() expression - Hung Hoang">







<meta property="og:url" content="">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:site" content="">

</head>
<body>
  <div class="container">

    
<article>
  <aside class="timestamp">
    <time>Posted by Hung Hoang on 2022-07-27 17:00</time>
    Â· <a href="./">view all posts</a>
  </aside>
  <h1>Upgrade django queries with F() expression</h1>
  <content>
    <h1 id="tl-dr">TL; DR</h1>
<p>When you reference to a model field for read/write operations, let's use F() expression
- Query of multiple objects: reduce queries
- A single object: no much difference in query time but it update value relative to what it is in the database -&gt; avoid dirty read -&gt; for example:
- Need to refresh_from_db after query because Python only knows about expression instead of actual result</p>
<h3 id="bulk-update">Bulk update</h3>
<p>Suppose the government in your country raise tax rate by 5% which makes you have to raise your listing product price by 20%. What would your django query look like ?
````
class Product(models.Model):</p>
<pre><code>name = models.TextField()
price = models.DecimalField()
in_stock = models.IntegerField(
    help_text="Number of items available in inventory"
)
</code></pre>
<pre><code>
A naive implementation of updating multiple products may be like this:
</code></pre>
<p>products = Product.objects.all()
for product in products:
    product.price =* 1.2
    product.save()</p>
<pre><code>
Think of it more carefully, we can realize that the new price is relative to the current price no matter what it is. Intuitively, we want to reference to `price` field of `Product` model when running update process.

And here it comes, F() expression. The Django official doc states:
&gt; An F() object represents the value of a model field, transformed value of a model field, or annotated column. 
&gt; It makes it possible to refer to model field values and perform database operations using them without actually having to pull them out of the database into Python memory.

Let's try the problem with `F()` and `update()` queryset method

</code></pre>
<p>from django.db.models import F</p>
<p>Product.objects.update(price=F("price")*1.2)</p>
<pre><code>Although the above query looks like a normal Python assignment of value to an instance attribute, in fact it is a SQL expression. This expression instruct database to increase the price field in database by 1.

New price value is based on current price value so we don't need to load it into Python memory. That's why F() comes into play.

### Update a single object
Let's say you want to update `in_stock` field after every order payment is completed.

A naive implementation may be like this
</code></pre>
<p>def process_payment(product: Product):
    with transaction.atomic():
        payment = Payment.objects.create(product=product)
        product.in_stock = product.in_stock - 1
        product.save(update_fields=["in_stock"])</p>
<pre><code>
So what's the problem ?
Let's imagine there are multiple users trying to make orders for a product, the scenario looks like this:
| Process 1               | Process 2                |  in_stock    |
| -----------             | -----------              | -----------
| Select `in_stock` -&gt; 5  |                          |  5
|                         | Select `in_stock` -&gt; 5   |  5
| Update `in_stock` = 5-1|                          |  4
|                         | Update `in_stock` = 5-1 |  4

In this case, two processes are updating `product.in_stock` at the same time but `in_stock` value just decrease by 1. That's incorrect.

The main issue is that you decrease `in_stock` based on what you fetched, what if you give database an instruction to update `in_stock` based on what is currently stored ?

</code></pre>
<p>def process_payment(product: Product):
    with transaction.atomic():
        payment = Payment.objects.create(product=product)
        product.in_stock = F("in_stock") - 1
        product.save(update_fields=["in_stock"]])</p>
<pre><code>
The difference between two approach is quite small but let's look at SQL generated by update commands:
- The naive approach:
</code></pre>
<p>UPDATE product_product
SET in_stock = 4
WHERE id = 262;</p>
<pre><code>This will decrease the quantity = 4 regardless of the current value of in_stock in database

- The F() approach:
</code></pre>
<p>UPDATE product_product
SET in_stock = in_stock + 1
WHERE id = 262;</p>
<pre><code>The quantity of product with id 262 will reduce by 1 and not set by a fixed value. This is how to use an F expression to solve the race condition problem.

### Note
The F() object which is assign to model field persist after saving model instance and will be applied on each `save()` so we need to `refresh_from_db` to get the updated instace. 

Try to read an instance without refreshing from database may lead to unexpected result:
</code></pre>
<p>In [12]: product = Product.objects.get(id=262)</p>
<p>In [13]: product.in_stock = F("in_stock") - 1</p>
<p>In [14]: product.save()</p>
<p>In [15]: product.n_vets
Out[15]: <CombinedExpression: F(in_stock) - Value(1)></p>
<p>In [16]: 
```</p>
<h3 id="summary">Summary</h3>
<p>Throughout the article, we pointed out two use cases of F() expression
- Reduce the number of queries some operations require by getting the database, rather than Python, to do work.
- Avoid race condition when two process retrieve and update the same instance.</p>
  </content>
 
  <!-- <aside class="support-me">
    ðŸ‘‹ Hey, if you found this post useful I would love to <a href="mailto:me@thea.codes">hear from you</a>.
    If you loved it you can consider <a href="https://ko-fi.com/theacodes" target="_blank" rel="noopener">tipping me on Ko-fi</a> or <a href="https://github.com/sponsors/theacodes" target="_blank" rel="noopener">sponsoring me</a> on GitHub.
    I don't get paid for this content, so kind words and support encourage me to create more!
  </aside> -->
</article>


    <footer>
      <div class="row">
        <div class="col-md-1 d-none d-md-block img-me-container">
          <img class="img-me img-fluid" src="./static/me.jpg">
        </div>
        <div class="col-md info">
          <span class="name">Hung Hoang</span><br>
          <!-- <a href="https://thea.codes"><i class="fa fa-link" aria-hidden="true"></i> thea.codes</a> -->
          Â· <a href="https://github.com/hoangquochung1110" rel="noopener"><i class="fab fa-github" aria-hidden="true"></i> hoangquochung1110</a>
          Â· <a href="https://www.instagram.com/h7ng__/" rel="noopener"><i class="fab fa-instagram" aria-hidden="true"></i> h7ng__</a>
          <br>
          <span class="location"><i class="fas fa-map-marker"></i> Saigon, Vietnam</span>
        </div>
        <div class="col-md">
          <p class="disclaimer">
            &copy; 2018 &mdash; 2020<br>
            All text is available under the <a href="https://creativecommons.org/licenses/by-sa/4.0/">CC-BY-SA 4.0</a> license<br>
            All code is available under the <a href="https://www.apache.org/licenses/LICENSE-2.0">Apache 2.0</a> license
          </p>
      </div>

    </footer>
  </div>

  <!-- webfonts & icons-->
  <link href="/static/fontawesome/css/fontawesome-all.min.css" rel="stylesheet">

  <!-- Google Analytics (that's right, I'm tracking you) -->
  <!-- <script async="" src="https://www.google-analytics.com/analytics.js"></script>
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-47725506-1', 'blog.thea.codes');
    ga('send', 'pageview');

  </script> -->
  <!-- Google Tag Manager (noscript) -->
  <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-TG55DGQ"
  height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
  <!-- End Google Tag Manager (noscript) -->

</body>
</html>