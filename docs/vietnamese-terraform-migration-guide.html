<!DOCTYPE html>
<html lang="en">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="author" content="Hung Hoang">
  <link rel="shortcut icon" href="https://hoangquochung1110.github.io/static-site-generator/favicon.ico">

  <title>TÃ¡i Cáº¥u TrÃºc Terraform: Chuyá»ƒn Äá»•i Tá»« State Monolithic Sang Kiáº¿n TrÃºc MÃ´-Ä‘un Theo MÃ´i TrÆ°á»ng - Hung Hoang</title>

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" href="./rss.xml"/>

  <!-- Bootstrap core CSS -->
  <link href="./static/bootstrap.min.css" rel="stylesheet">

  <!-- Custom styles for this template -->
  <link href="./static/style.css" rel="stylesheet">

  <!-- Syntax highlighting css -->
  <link href="./static/pygments.css" rel="stylesheet">

  <!-- Google Tag Manager -->
  <script>
    (function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
    j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
    'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-TG55DGQ');
  </script>
  <!-- End Google Tag Manager -->
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-235710440-2"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-235710440-2');
  </script>
  <!-- End Global site tag (gtag.js) - Google Analytics -->
  <!-- Google Console Verify-->
  <meta name="google-site-verification" content="OgYcJ0DRlzDfeYySnQ7N5_zh_QDavnLwdffF-NQYb6c" />
  <!-- End Google Console Verify-->

  <!-- beam analytics -->
  <script src="https://beamanalytics.b-cdn.net/beam.min.js" data-token="19aab194-2a12-4585-bf30-e8b0c1e45d01" async></script>
  <!-- End beam analytics -->

  
<meta property="og:title" content="TÃ¡i Cáº¥u TrÃºc Terraform: Chuyá»ƒn Äá»•i Tá»« State Monolithic Sang Kiáº¿n TrÃºc MÃ´-Ä‘un Theo MÃ´i TrÆ°á»ng - Hung Hoang">
<meta property="twitter:title" content="TÃ¡i Cáº¥u TrÃºc Terraform: Chuyá»ƒn Äá»•i Tá»« State Monolithic Sang Kiáº¿n TrÃºc MÃ´-Ä‘un Theo MÃ´i TrÆ°á»ng - Hung Hoang">


<meta name="description" content="HÆ°á»›ng dáº«n sÆ¡ khai tÃ¡i cáº¥u trÃºc Terraform tá»« state Ä‘Æ¡n láº» sang kiáº¿n trÃºc module theo mÃ´i trÆ°á»ng, giÃºp quáº£n lÃ½ state hiá»‡u quáº£, tÃ¡i sá»­ dá»¥ng mÃ£ vÃ  giáº£m rá»§i ro triá»ƒn khai.">
<meta property="og:description" content="HÆ°á»›ng dáº«n sÆ¡ khai tÃ¡i cáº¥u trÃºc Terraform tá»« state Ä‘Æ¡n láº» sang kiáº¿n trÃºc module theo mÃ´i trÆ°á»ng, giÃºp quáº£n lÃ½ state hiá»‡u quáº£, tÃ¡i sá»­ dá»¥ng mÃ£ vÃ  giáº£m rá»§i ro triá»ƒn khai.">
<meta property="twitter:description" content="HÆ°á»›ng dáº«n sÆ¡ khai tÃ¡i cáº¥u trÃºc Terraform tá»« state Ä‘Æ¡n láº» sang kiáº¿n trÃºc module theo mÃ´i trÆ°á»ng, giÃºp quáº£n lÃ½ state hiá»‡u quáº£, tÃ¡i sá»­ dá»¥ng mÃ£ vÃ  giáº£m rá»§i ro triá»ƒn khai.">






<meta property="og:url" content="/">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:site" content="">

</head>
<body>
  <div class="container">

    
<article>
  <aside class="timestamp">
    <time>Posted by Hung Hoang on 2025-04-20 10:00</time>
    Â· <a href="./">view all posts</a>
  </aside>
  <h1>TÃ¡i Cáº¥u TrÃºc Terraform: Chuyá»ƒn Äá»•i Tá»« State Monolithic Sang Kiáº¿n TrÃºc MÃ´-Ä‘un Theo MÃ´i TrÆ°á»ng</h1>
  <content>
    <p>Trong quÃ¡ trÃ¬nh phÃ¡t triá»ƒn cÃ´ng cá»¥ tá»± Ä‘Ã´ng hoÃ¡ truy váº¥n Google Maps theo Ä‘á»‹a chá»‰ dÆ°á»›i dáº¡ng vÄƒn báº£n trÃªn ná»n táº£ng Instagram (chi tiáº¿t táº¡i <a href="https://www.facebook.com/groups/j2team.community/posts/2642859852712785/">Ä‘Ã¢y</a>), nháº­n tháº¥y sá»± cáº§n thiáº¿t trong viá»‡c chuyá»ƒn Ä‘á»•i cáº¥u trÃºc quáº£n lÃ­ tráº¡ng thÃ¡i cá»§a Terraform tá»« dáº¡ng pháº³ng, phi cáº¥u trÃºc, monolith sang dáº¡ng mÃ´-Ä‘un, phÃ¢n tÃ¡ch mÃ´i trÆ°á»ng theo file directory</p>
<h1 id="tai-cau-truc-terraform-chuyen-oi-tu-state-monolithic-sang-kien-truc-mo-un-theo-moi-truong">TÃ¡i Cáº¥u TrÃºc Terraform: Chuyá»ƒn Äá»•i Tá»« State Monolithic Sang Kiáº¿n TrÃºc MÃ´-Ä‘un Theo MÃ´i TrÆ°á»ng</h1>
<p>HÆ°á»›ng dáº«n sÆ¡ khai cÃ¡c bÆ°á»›c Ä‘á»ƒ tá»• chá»©c láº¡i codebase Terraform cá»§a báº¡n Ä‘á»ƒ cÃ³ sá»± tÃ¡ch biá»‡t, tÃ¡i sá»­ dá»¥ng vÃ  triá»ƒn khai an toÃ n hÆ¡n.</p>
<hr />
<h2 id="1-to-chuc-state-ban-au">1. Tá»• Chá»©c State Ban Äáº§u</h2>
<p><strong>Cáº¥u TrÃºc &amp; Quy TrÃ¬nh</strong>
- Má»™t thÆ° má»¥c gá»‘c <code>terraform/</code> vá»›i <code>main.tf</code>, <code>variables.tf</code>, v.v.
- Má»™t file state duy nháº¥t (<code>terraform.tfstate</code>), thÆ°á»ng Ä‘Æ°á»£c lÆ°u trá»¯ trong S3 hoáº·c cá»¥c bá»™.
- Sá»­ dá»¥ng <code>.tfvars</code> (<code>dev.tfvars</code>, <code>prod.tfvars</code>) ghi Ä‘Ã¨ biáº¿n Ä‘á»ƒ phÃ¢n tÃ¡ch mÃ´i trÆ°á»ng.</p>
<p><strong>Lá»£i Ã­ch</strong>
- Cáº¥u trÃºc Ä‘Æ¡n giáº£n, trá»±c quan Ä‘á»‘i vá»›i ngÆ°á»i má»›i vÃ  dá»± Ã¡n nhá».</p>
<p><strong>Háº¡n Cháº¿ &amp; NhÆ°á»£c Äiá»ƒm</strong>
Sáº½ bá»™c lá»™ khi sá»‘ lÆ°á»£ng tÃ i nguyÃªn tÄƒng lÃªn:
- State phÃ¬nh to: táº¥t cáº£ tÃ i nguyÃªn (dev/staging/prod) Ä‘á»u náº±m trong má»™t file.
- Triá»ƒn khai rá»§i ro: vÃ´ tÃ¬nh thay Ä‘á»•i tÃ i nguyÃªn production.
- MÃ´-Ä‘un hÃ³a kÃ©m: má»i thay Ä‘á»•i Ä‘á»‘i vá»›i API, IAM, Lambda Ä‘á»u náº±m trong cÃ¹ng má»™t file.
- KhÃ´ng cÃ³ ranh giá»›i rÃµ rÃ ng: khÃ³ Ä‘á»ƒ Ä‘Ã o táº¡o thÃ nh viÃªn má»›i hoáº·c phÃ¢n chia trÃ¡ch nhiá»‡m.</p>
<hr />
<p><img alt="Modularize Terraform management" src="https://static.ssan.me/tf_modularization_dont_do.png" /></p>
<h2 id="2-gioi-thieu-ve-module-terraform">2. Giá»›i Thiá»‡u Vá» Module Terraform</h2>
<p><strong>Module LÃ  GÃ¬?</strong>
Má»™t thÆ° má»¥c chá»©a mÃ£ Terraform (resources, inputs, outputs) mÃ  báº¡n cÃ³ thá»ƒ gá»i tá»« má»™t cáº¥u hÃ¬nh khÃ¡c.
- <strong>Root module</strong>: <code>main.tf</code> cáº¥p cao nháº¥t vÃ  cÃ¡c file liÃªn quan.
- <strong>Child modules</strong>: cÃ¡c khá»‘i xÃ¢y dá»±ng cÃ³ thá»ƒ tÃ¡i sá»­ dá»¥ng (vÃ­ dá»¥: <code>modules/lambda/</code>).</p>
<p><strong>Kiáº¿n TrÃºc vÃ  Giao Tiáº¿p Cá»§a Module</strong></p>
<p>Má»™t module Terraform khÃ´ng chá»‰ lÃ  má»™t thÆ° má»¥c mÃ£â€”nÃ³ lÃ  má»™t Ä‘á»‘i tÆ°á»£ng Ä‘Ã³ng gÃ³i Ä‘á»™c láº­p vá»›i má»™t há»£p Ä‘á»“ng (rÃ ng buá»™c) rÃµ rÃ ng vá» cÃ¡ch tÆ°Æ¡ng tÃ¡c vá»›i tháº¿ giá»›i bÃªn ngoÃ i thÃ´ng qua biáº¿n (<code>var</code>):</p>
<pre><code>modules/lambda/
â”œâ”€â”€ **main.tf**         # Äá»‹nh nghÄ©a tÃ i nguyÃªn chÃ­nh
â”œâ”€â”€ **variables.tf**    # Tham sá»‘ Ä‘áº§u vÃ o (API cá»§a module)
â”œâ”€â”€ **outputs.tf**      # GiÃ¡ trá»‹ Ä‘Æ°á»£c hiá»ƒn thá»‹ cho module cha
â”œâ”€â”€ locals.tf       # TÃ­nh toÃ¡n vÃ  biáº¿n Ä‘á»•i ná»™i bá»™
â”œâ”€â”€ data.tf         # Data sources vÃ  lookups
â””â”€â”€ README.md       # TÃ i liá»‡u vá» má»¥c Ä‘Ã­ch, inputs, vÃ  outputs
</code></pre>
<p>Má»—i file cÃ³ má»™t má»¥c Ä‘Ã­ch cá»¥ thá»ƒ:</p>
<p><strong>main.tf</strong> - Chá»©a vÃ  táº­p há»£p cÃ¡c Ä‘á»‹nh nghÄ©a tÃ i nguyÃªn cá»‘t lÃµi (thÆ°á»ng Ä‘i kÃ¨m vá»›i nhau) Ä‘á»ƒ thá»±c hiá»‡n má»™t hÃ nh Ä‘á»™ng/tÃ­nh nÄƒng hoÃ n chá»‰nh mÃ  module táº¡o vÃ  quáº£n lÃ½. Äá»‘i vá»›i module Lambda, nÃ³ sáº½ bao gá»“m:</p>
<pre><code>resource &quot;aws_lambda_function&quot; &quot;functions&quot; {
  for_each = var.functions

  function_name = &quot;${var.name_prefix}-${each.key}&quot;
  handler       = each.value.handler
  runtime       = each.value.runtime
  role          = var.execution_role_arn

  filename         = each.value.source_file
  source_code_hash = filebase64sha256(each.value.source_file)

  memory_size = each.value.memory_size
  timeout     = each.value.timeout

  environment {
    variables = merge(var.common_environment_variables, each.value.environment_variables)
  }

  tags = merge(var.common_tags, each.value.tags)
}

# CÃ¡c tÃ i nguyÃªn bá»• sung nhÆ° permissions, CloudWatch log groups, v.v.
</code></pre>
<p><strong>variables.tf</strong> - Äá»‹nh nghÄ©a cÃ¡c tham sá»‘ Ä‘áº§u vÃ o cá»§a module, vá»›i mÃ´ táº£ vÃ  rÃ ng buá»™c kiá»ƒu:</p>
<pre><code>variable &quot;name_prefix&quot; {
  description = &quot;Tiá»n tá»‘ Ä‘Æ°á»£c thÃªm vÃ o trÆ°á»›c táº¥t cáº£ tÃªn tÃ i nguyÃªn&quot;
  type        = string
}

variable &quot;functions&quot; {
  description = &quot;Báº£n Ä‘á»“ cÃ¡c hÃ m Lambda cáº§n táº¡o&quot;
  type = map(object({
    handler               = string
    runtime               = string
    source_file           = string
    memory_size           = number
    timeout               = number
    environment_variables = map(string)
    tags                  = map(string)
  }))
}

variable &quot;execution_role_arn&quot; {
  description = &quot;ARN cá»§a IAM role Ä‘Æ°á»£c sá»­ dá»¥ng bá»Ÿi cÃ¡c hÃ m Lambda&quot;
  type        = string
}

variable &quot;common_environment_variables&quot; {
  description = &quot;Biáº¿n mÃ´i trÆ°á»ng Ã¡p dá»¥ng cho táº¥t cáº£ cÃ¡c hÃ m&quot;
  type        = map(string)
  default     = {}
}

variable &quot;common_tags&quot; {
  description = &quot;Tags Ã¡p dá»¥ng cho táº¥t cáº£ tÃ i nguyÃªn&quot;
  type        = map(string)
  default     = {}
}
</code></pre>
<p><strong>outputs.tf</strong> - Äá»‹nh nghÄ©a cÃ¡c giÃ¡ trá»‹ mÃ  module hiá»ƒn thá»‹ cho cÃ¡c module cha:</p>
<pre><code>output &quot;function_arns&quot; {
  description = &quot;ARNs cá»§a cÃ¡c hÃ m Lambda Ä‘Ã£ táº¡o&quot;
  value = {
    for name, function in aws_lambda_function.functions : name =&gt; function.arn
  }
}

output &quot;function_names&quot; {
  description = &quot;TÃªn cá»§a cÃ¡c hÃ m Lambda Ä‘Ã£ táº¡o&quot;
  value = {
    for name, function in aws_lambda_function.functions : name =&gt; function.function_name
  }
}

output &quot;invoke_urls&quot; {
  description = &quot;URLs cÆ¡ sá»Ÿ Ä‘á»ƒ gá»i cÃ¡c hÃ m Lambda (náº¿u tÃ­ch há»£p API Gateway Ä‘Æ°á»£c báº­t)&quot;
  value = {
    for name, _ in var.functions :
    name =&gt; aws_apigatewayv2_stage.api[name].invoke_url
    if contains(keys(aws_apigatewayv2_stage.api), name)
  }
}
</code></pre>
<p><img alt="Module with input and output" src="https://static.ssan.me/tf_module_input_output.png" /></p>
<p><strong>Sá»± Káº¿t Há»£p vÃ  TÃ¡i Sá»­ Dá»¥ng Module</strong></p>
<p>CÃ¡c module cÃ³ thá»ƒ gá»i cÃ¡c module khÃ¡c, táº¡o thÃ nh má»™t máº«u káº¿t há»£p. Äiá»u nÃ y cho phÃ©p báº¡n xÃ¢y dá»±ng cÃ¡c trá»«u tÆ°á»£ng cáº¥p cao hÆ¡n:</p>
<pre><code># BÃªn trong má»™t module &quot;serverless_api&quot; káº¿t há»£p cÃ¡c module khÃ¡c
module &quot;lambda&quot; {
  source = &quot;../lambda&quot;

  name_prefix        = var.name_prefix
  functions          = var.functions
  execution_role_arn = module.iam.lambda_execution_role_arn
}

module &quot;api_gateway&quot; {
  source = &quot;../api_gateway&quot;

  name_prefix     = var.name_prefix
  api_name        = &quot;${var.name_prefix}-api&quot;
  lambda_function = module.lambda.function_arns[&quot;api_handler&quot;]
  stage_name      = var.environment
}

module &quot;iam&quot; {
  source = &quot;../iam&quot;

  name_prefix = var.name_prefix
  services    = [&quot;lambda.amazonaws.com&quot;]
}
</code></pre>
<p><strong>PhiÃªn Báº£n Module</strong></p>
<p>Äá»ƒ Ä‘áº£m báº£o tÃ­nh á»•n Ä‘á»‹nh, báº¡n nÃªn Ä‘Ã¡nh phiÃªn báº£n cho cÃ¡c module cá»§a mÃ¬nh báº±ng má»™t trong nhá»¯ng cÃ¡ch tiáº¿p cáº­n sau:</p>
<ol>
<li>
<p><strong>Tham chiáº¿u Git</strong> - Gáº¯n vá»›i má»™t commit hoáº·c tag cá»¥ thá»ƒ:
   <code>module "lambda" {
     source = "git::https://github.com/company/terraform-modules.git//modules/lambda?ref=v1.2.3"
     # Cáº¥u hÃ¬nh module...
   }</code></p>
</li>
<li>
<p><strong>Terraform Registry</strong> - Cho cÃ¡c module trong registry cÃ´ng khai hoáº·c riÃªng tÆ°:
   <code>module "lambda" {
     source  = "terraform-aws-modules/lambda/aws"
     version = "2.7.0"
     # Cáº¥u hÃ¬nh module...
   }</code></p>
</li>
<li>
<p><strong>ÄÆ°á»ng dáº«n cá»¥c bá»™ vá»›i phiÃªn báº£n</strong> - Cho phÃ¡t triá»ƒn ná»™i bá»™:
   <code>module "lambda" {
     source = "../../modules/lambda"  # Vá»›i quy trÃ¬nh kiá»ƒm soÃ¡t phiÃªn báº£n ná»™i bá»™
     # Cáº¥u hÃ¬nh module...
   }</code></p>
</li>
</ol>
<p><strong>Lá»£i Ãch</strong>
- ÄÃ³ng gÃ³i: nhÃ³m cÃ¡c tÃ i nguyÃªn liÃªn quan (Lambda + aliases + permissions).
- TÃ¡i sá»­ dá»¥ng: chia sáº» cÃ¡c máº«u tiÃªu chuáº©n giá»¯a cÃ¡c dá»± Ã¡n.
- TÃ¹y biáº¿n: hiá»ƒn thá»‹ inputs (<code>var.memory_size</code>, <code>var.aliases</code>) vÃ  outputs.
- ÄÃ¡nh phiÃªn báº£n: gáº¯n nguá»“n module vá»›i má»™t Git tag hoáº·c phiÃªn báº£n registry.</p>
<p><strong>CÃ¡ch Sá»­ Dá»¥ng</strong></p>
<pre><code>module &quot;lambda&quot; {
  source             = &quot;../../modules/lambda&quot;
  functions          = local.lambda_functions
  execution_role_arn = module.iam.execution_role_arn
}
</code></pre>
<ul>
<li>Äá»‹nh nghÄ©a inputs (maps, lists, primitives).</li>
<li>Sá»­ dá»¥ng outputs (<code>module.lambda.alias_arns["myfunc_dev"]</code>).</li>
<li>Táº­n dá»¥ng <code>for_each</code> / <code>count</code> cho tÃ­nh nÄƒng Ä‘á»™ng.</li>
</ul>
<hr />
<h2 id="3-cau-truc-moi-mo-un-hoa-huong-theo-moi-truong">3. Cáº¥u TrÃºc Má»›i: MÃ´-Ä‘un HÃ³a, HÆ°á»›ng Theo MÃ´i TrÆ°á»ng</h2>
<pre class="lang-text">terraform/
â”œâ”€â”€ environments/
â”‚   â”œâ”€â”€ dev/
â”‚   â”‚   â””â”€â”€ main.tf
â”‚   â”œâ”€â”€ staging/
â”‚   â”‚   â””â”€â”€ main.tf
â”‚   â””â”€â”€ prod/
â”‚       â””â”€â”€ main.tf
â””â”€â”€ modules/
    â”œâ”€â”€ lambda/
    â”œâ”€â”€ iam/
    â”œâ”€â”€ api_gateway/
    â””â”€â”€ cloudwatch/
</pre>
<ul>
<li><strong>ThÆ° má»¥c theo mÃ´i trÆ°á»ng</strong>: cÃ´ láº­p state, vars, backends.</li>
<li><strong>Modules</strong>: triá»ƒn khai cÃ¡c váº¥n Ä‘á» cá»‘t lÃµi (compute, IAM, logging, API).</li>
<li><strong>Locals &amp; tagging</strong>: Ä‘á»‹nh nghÄ©a <code>local.project</code>, <code>local.environment</code>, <code>local.common_tags</code> trong má»—i mÃ´i trÆ°á»ng.</li>
</ul>
<hr />
<h2 id="5-migrate-quan-ly-state">5. Migrate &amp; Quáº£n LÃ½ State</h2>
<p>á» pháº§n pháº§n nÃ y, mÃ­nh sáº½ giá»›i thiá»‡u qua cÃ¡c lá»‡nh phá»• biá»ƒn cá»§a Terraform CLI Ä‘á»ƒ dá»‹ch chuyá»ƒn state vÃ  cÃ¡c tÃ i nguyÃªn liÃªn quan.</p>
<p>CÃ³ it nháº¥t 2 cÃ¡ch Ä‘á»ƒ thá»±c hiá»‡n:
- <code>terraform state rm</code> vÃ  <code>terraform import</code> Ä‘á»ƒ import tÃ i nguyÃªn vÃ o module má»›i.
- Sá»­ dá»¥ng <code>terraform state mv</code> Ä‘á»ƒ di chuyá»ƒn tÃ i nguyÃªn vÃ o module má»›i.</p>
<p>ğŸ“Œ Äi kÃ¨m lÃ  2 cÃ´ng cá»¥ Ä‘áº¯c lá»±c Ä‘á»ƒ theo dÃµi hiá»‡n tráº¡ng state: <code>terraform state list</code> vÃ  <code>terraform state show</code>.</p>
<h3 id="su-dung-terraform-state-rm-va-terraform-import-e-import-tai-nguyen-vao-module-moi"><strong>Sá»­ dá»¥ng <code>terraform state rm</code> vÃ  <code>terraform import</code> Ä‘á»ƒ import tÃ i nguyÃªn vÃ o module má»›i</strong></h3>
<p>Flow cÆ¡ báº£n:
1. khá»Ÿi táº¡o state cho tá»«ng mÃ´i trÆ°á»ng, á»Ÿ Ä‘Ã¢y lÃ  <code>dev</code></p>
<pre class="lang-bash"><span class="nb">cd</span><span class="w"> </span>terraform/environments/dev
terraform<span class="w"> </span>init<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-backend-config<span class="o">=</span><span class="s2">&quot;key=dev/terraform.tfstate&quot;</span>
</pre>
<ol>
<li>Äá»‹nh nghÄ©a module á»Ÿ mÃ´i trÆ°á»ng má»›i</li>
</ol>
<pre><code># my_project/terraform/modules/lambda/main.tf
resource &quot;aws_lambda_function&quot; &quot;my_lambda_function&quot; {
  function_name = var.function_name

  # Function-specific configuration
  handler          = var.handler
  runtime          = var.runtime
}
</code></pre>
<ol>
<li>Äá»‹nh nghÄ©a cÃ¡c biáº¿n Ä‘áº§u vÃ o cho module trÃªn</li>
</ol>
<pre><code># my_project/terraform/modules/lambda/variables.tf
variable &quot;function_name&quot; {
  type = string
}

variable &quot;handler&quot; {
  type = string
}

variable &quot;runtime&quot; {
  type = string
}
</code></pre>
<ol>
<li>Gá»i module lambda trong file <code>main.tf</code> cá»§a mÃ´i trÆ°á»ng má»›i</li>
</ol>
<p>Äá»ƒ Ä‘Æ¡n giáº£n, chÃºng ta hardcode cÃ¡c tham sá»‘ Ä‘áº§u vÃ o, tuy nhiÃªn thá»±c táº¿ chÃºng ta nÃªn Ä‘á»‹nh nghÄ©a cÃ¡c biáº¿n Ä‘áº§u vÃ o trong <code>variables.tf</code> káº¿t há»£p <code>terraform.tfvars</code> cá»§a module.</p>
<pre><code># my_project/terraform/environments/dev/main.tf
module &quot;lambda&quot; {
  source = &quot;../../modules/lambda&quot;

  function_name = &quot;my_lambda_function&quot;
  handler       = &quot;index.handler&quot;
  runtime       = &quot;python3.8&quot;
}
</code></pre>
<ol>
<li>XÃ¡c Ä‘á»‹nh tÃ i nguyÃªn cáº§n di chuyá»ƒn á»Ÿ mÃ´i trÆ°á»ng cÅ©`
Táº¡i mÃ´i trÆ°á»ng cÅ©, hÃ£y xem cÃ¡c tÃ i nguyÃªn hiá»‡n cÃ³ rá»“i xoÃ¡ tÃ i nguyÃªn khá»i file tráº¡ng thÃ¡i:</li>
</ol>
<pre><code># my_project/
&gt; terraform state list
&gt; terraform state show aws_lambda_function.my_lambda_function
&gt; terraform state rm aws_lambda_function.my_lambda_function
</code></pre>
<p>Rá»“i xoÃ¡ thá»§ cÃ´ng tÃ i nguyÃªn trÃªn khá»i code á»Ÿ mÃ´i trÆ°á»ng cÅ©.</p>
<ol>
<li>Import tÃ i nguyÃªn vÃ o module má»›i</li>
</ol>
<pre><code># my_project/terraform/environments/dev
&gt; terraform import module.lambda.aws_lambda_function.my_lambda_function &lt;resource_id&gt;
</code></pre>
<p>Báº¡n cÃ³ thá»ƒ pháº£i cáº§n truyá»n cÃ¡c tham sá»‘ Ä‘áº§u vÃ o thÃ´ng qua flag <code>--var</code> hoáº·c <code>--var-file</code>.
VÃ­ dá»¥:</p>
<pre><code>&gt; terraform import module.lambda.aws_lambda_function.my_lambda_function &lt;resource_id&gt; --var &quot;function_name = 'my_lambda_function'&quot; --var &quot;handler = 'index.handler'&quot; --var &quot;runtime = 'python3.8'&quot;
</code></pre>
<hr />
<h2 id="6-xac-minh-qua-trinh-chuyen-oi">6. XÃ¡c Minh QuÃ¡ TrÃ¬nh Chuyá»ƒn Äá»•i</h2>
<p><strong>XÃ¡c Thá»±c Báº±ng Plan</strong>
   <code>bash
   terraform plan</code>
   - XÃ¡c nháº­n khÃ´ng cÃ³ thay Ä‘á»•i (cÃ¡c tÃ i nguyÃªn trá» Ä‘áº¿n cÃ¹ng má»™t cÆ¡ sá»Ÿ háº¡ táº§ng váº­t lÃ½).</p>
<ul>
<li><strong>Liá»‡t kÃª state</strong>
  <code>bash
  terraform state list</code></li>
<li><strong>Hiá»ƒn thá»‹ chi tiáº¿t tÃ i nguyÃªn</strong>
  <code>bash
  terraform state show module.lambda.aws_lambda_function.functions["ig_post_extractor"]</code></li>
<li><strong>Káº¿t quáº£ plan</strong></li>
<li>KhÃ´ng cÃ³ thay Ä‘á»•i Ä‘á»“ng nghÄ©a vá»›i thÃ nh cÃ´ng.</li>
<li>Báº¥t ká»³ sá»± khÃ¡c biá»‡t nÃ o cho tháº¥y má»™t sá»± Ã¡nh xáº¡ sai cáº§n pháº£i sá»­a báº±ng <code>state mv</code> hoáº·c cáº­p nháº­t biáº¿n.</li>
<li><strong>Triá»ƒn Khai Qua CÃ¡c MÃ´i TrÆ°á»ng</strong></li>
<li>Láº·p láº¡i init/import/plan trong <code>staging</code> vÃ  <code>prod</code>.</li>
<li>Má»—i mÃ´i trÆ°á»ng sá»­ dá»¥ng khÃ³a backend state riÃªng (<code>staging/terraform.tfstate</code>, v.v.).</li>
</ul>
<p><strong>Cáº¥u TrÃºc Cuá»‘i CÃ¹ng ThÃ nh CÃ´ng</strong></p>
<p>Sau khi di chuyá»ƒn, cáº¥u trÃºc cá»§a chÃºng ta trÃ´ng nhÆ° tháº¿ nÃ y:</p>
<pre><code>terraform/
â”œâ”€â”€ environments/
â”‚   â”œâ”€â”€ dev/
â”‚   â”‚   â”œâ”€â”€ main.tf
â”‚   â”‚   â””â”€â”€ terraform.tfstate (trong S3)
â”‚   â”œâ”€â”€ staging/
â”‚   â”‚   â”œâ”€â”€ main.tf
â”‚   â”‚   â””â”€â”€ terraform.tfstate (trong S3)
â”‚   â””â”€â”€ prod/
â”‚       â”œâ”€â”€ main.tf
â”‚       â””â”€â”€ terraform.tfstate (trong S3)
â””â”€â”€ modules/
    â”œâ”€â”€ lambda/
    â”œâ”€â”€ api_gateway/
    â”œâ”€â”€ iam/
    â””â”€â”€ cloudwatch/
</code></pre>
<hr />
<h2 id="7-ket-qua">7. Káº¿t Quáº£</h2>
<ul>
<li><strong>TÃ¡ch biá»‡t</strong>: má»—i mÃ´i trÆ°á»ng cÃ³ state riÃªng, khÃ´ng cÃ³ sá»± nhiá»…m chÃ©o.</li>
<li><strong>MÃ´-Ä‘un hÃ³a</strong>: cÃ¡c module Ä‘Ã³ng gÃ³i cÃ¡c phÆ°Æ¡ng phÃ¡p hay nháº¥t vÃ  dá»… dÃ ng Ä‘Ã¡nh phiÃªn báº£n.</li>
<li><strong>Láº·p láº¡i</strong>: táº¡o mÃ´i trÆ°á»ng má»›i báº±ng cÃ¡ch sao chÃ©p má»™t thÆ° má»¥c vÃ  Ä‘iá»u chá»‰nh cÃ¡c biáº¿n.</li>
<li><strong>An toÃ n</strong>: cÃ¡c lá»‡nh <code>plan</code> + <code>state</code> Ä‘áº£m báº£o di chuyá»ƒn cÃ³ kiá»ƒm soÃ¡t, khÃ´ng bá»‹ giÃ¡n Ä‘oáº¡n.</li>
<li><strong>Dá»… báº£o trÃ¬</strong>: thÃ nh viÃªn má»›i trong nhÃ³m cÃ³ thá»ƒ nhanh chÃ³ng hiá»ƒu cáº¥u trÃºc codebase.</li>
<li><strong>Quáº£n trá»‹</strong>: dá»… dÃ ng triá»ƒn khai quy trÃ¬nh phÃª duyá»‡t cho tá»«ng mÃ´i trÆ°á»ng.</li>
</ul>
<p>Sau khi di chuyá»ƒn, cÃ¡c nhÃ³m cÃ³ thá»ƒ lÃ m viá»‡c Ä‘á»™c láº­p trÃªn cÃ¡c mÃ´i trÆ°á»ng hoáº·c module khÃ¡c nhau, vá»›i ranh giá»›i rÃµ rÃ ng vÃ  giáº£m nguy cÆ¡ thay Ä‘á»•i vÃ´ tÃ¬nh cÃ¡c tÃ i nguyÃªn sáº£n xuáº¥t.</p>
  </content>
</article>


    <footer>
      <div class="row">
        <div class="col-md-1 d-none d-md-block img-me-container">
          <img class="img-me img-fluid" src="./static/me.webp">
        </div>
        <div class="col-md info">
          <span class="name">Hung Hoang</span><br>
          Â· <a href="https://github.com/hoangquochung1110" rel="noopener"><i class="fab fa-github" aria-hidden="true"></i> hoangquochung1110</a>
          Â· <a href="https://www.instagram.com/h7ng__/" rel="noopener"><i class="fab fa-instagram" aria-hidden="true"></i> h7ng__</a>
          <br>
          <span class="location"><i class="fas fa-map-marker"></i> Saigon, Vietnam</span>
        </div>
        <div class="col-md">
          <p class="disclaimer">
            &copy; 2022 &mdash; 2022<br>
            All text is available under the <a href="https://creativecommons.org/licenses/by-sa/4.0/">CC-BY-SA 4.0</a> license<br>
            All code is available under the <a href="https://www.apache.org/licenses/LICENSE-2.0">Apache 2.0</a> license
          </p>
      </div>

    </footer>
  </div>

  <!-- webfonts & icons-->
  <link href="/static/fontawesome/css/fontawesome-all.min.css" rel="stylesheet">
  <!-- Google Tag Manager (noscript) -->
  <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-TG55DGQ"
  height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
  <!-- End Google Tag Manager (noscript) -->
</body>
</html>